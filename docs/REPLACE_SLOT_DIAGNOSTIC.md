# Диагностика: План на день → замена блюда (replace_slot)

## Цикл запроса

1. **Клиент** (вкладка «План») вызывает `replace_slot`: день + слот (breakfast/lunch/snack/dinner) + профиль (аллергии, предпочтения).
2. **generate-plan** (Edge):
   - Пытается взять рецепт из пула (БД). Если кандидатов мало (quality gate) и пользователь Premium/Trial → **AI fallback**.
   - Вызывает **deepseek-chat** с `type: "recipe"`, `from_plan_replace: true`, промпт «сгенерируй один рецепт для завтрак/обед/…» + подсказка по аллергиям.
3. **deepseek-chat** (Edge):
   - Генерирует JSON рецепта. При `from_plan_replace: true` **рецепт не сохраняет** (не вызывает `create_recipe_with_steps`), только возвращает `message` + `recipes`.
4. **generate-plan** снова:
   - Парсит `aiData.message` → `parseAndValidateAi`.
   - **Валидация** (порядок важен):
     - **1) Аллергия** — по названию + ингредиентам + шагам; при совпадении с токенами аллергии → `allergy` → retry с «СТРОГО БЕЗ МОЛОЧНЫХ…».
     - **2) Количество ингредиентов** — минимум 3 ингредиента с количеством/единицей или «по вкусу»/«для жарки» и т.п. → иначе `ingredients_no_amount` → retry по количествам, затем repair.
     - **3) Sanity слота** — завтрак не суп/рагу, обед не сырники и т.д.
   - Если валидация **не прошла** → ответ `replace_failed` / `ai_invalid_ingredients`, **рецепт в БД не создаётся**.
   - Если валидация **прошла** → `create_recipe_with_steps` (payload с ингредиентами) → запись в **recipes** + **recipe_ingredients** + **recipe_steps** → привязка к **meal_plans_v2** (день + слот).

Итого: рецепты из плана попадают в `recipes` **только после успешной валидации** и только из generate-plan.

---

## Что было сломано и что починили

| Проблема | Причина | Что сделано |
|----------|--------|-------------|
| **Рецепты не находятся в `recipes`** | Раньше deepseek-chat сохранял рецепт до валидации. При падении валидации в generate-plan рецепт уже был в БД («сирота»). Потом ввели `from_plan_replace` и сохранение только в generate-plan — теперь при падении валидации рецепт **вообще не создаётся**, поэтому в `recipes` за последние часы ничего не появлялось. | Логика корректна: сохраняем только после успешной валидации. Проблема была в том, что валидация слишком часто падала (см. ниже). |
| **В логах `action_type: chat_recipe` для замен в плане** | Все вызовы deepseek из плана логировались как «рецепт в чате». | В запросы от generate-plan добавлен флаг `from_plan_replace: true`; в deepseek при нём пишется `action_type: plan_replace` и рецепт не сохраняется. |
| **Аллергия на молоко, но ИИ предлагает «Творожные оладьи»** | В `validateAiMeal` **сначала** проверялись ингредиенты (ingredients_no_amount), **потом** аллергия. Рецепт с творогом падал по «нет количеств» и до проверки аллергии дело не доходило → retry шёл по количествам, а не «без молочных». | Порядок проверок изменён: **сначала аллергия**, затем количества ингредиентов, затем sanity. При аллергии сразу делается retry с подсказкой «СТРОГО БЕЗ МОЛОЧНЫХ…». |
| **После 6 замен на 7-й ошибка «не удалось»** | Валидатор требовал **все** ингредиенты с количеством; один без количества (соль, масло для жарки) ронял рецепт. Плюс repair мог отдавать `display_text` без единицы. | Достаточно **≥3** ингредиентов с количеством/качеством; добавлены «для жарки», «для смазки» и т.д.; после repair явно собирается `display_text` с единицей; в regex учтён «шт.» с точкой. |
| **«Сироты» в БД (рецепты без привязки к плану)** | deepseek-chat при вызове из плана сохранял рецепт, generate-plan при failed validation не привязывал его к плану. | При `from_plan_replace: true` deepseek-chat **не сохраняет** рецепт; создаёт и привязывает только generate-plan после успешной валидации. |

---

## Текущий порядок валидации (validateAiMeal)

1. **Аллергия** — по title + ингредиенты + steps; при совпадении с токенами аллергии → `allergy`.
2. **Количество ингредиентов** — минимум 3 с количеством/единицей или качественным описанием → иначе `ingredients_no_amount`.
3. **Sanity слота** — завтрак/обед/ужин/полдник по правилам → иначе sanity.

---

## Где что сохраняется

- **recipes** — только из generate-plan через `create_recipe_with_steps` после успешной валидации (replace_slot / week fallback / upgrade).
- **meal_plans_v2.meals** — при успешной замене: `{ [mealType]: { recipe_id, title, plan_source: "ai" } }`.
- **token_usage_log** — из deepseek-chat: при вызове из плана `action_type: plan_replace`, из чата — `chat_recipe`.

После исправления порядка проверок (аллергия → ингредиенты → sanity) и ослабления требований по количествам замена завтрака при аллергии на молоко должна сначала отсекать творожные/молочные рецепты и делать retry без молочного, а при успешной валидации — сохранять рецепт и привязывать к плану.
