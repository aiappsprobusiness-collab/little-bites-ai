# Алиасы и аббревиатуры аллергий

Словарь алиасов используется для:
- **нормализации ввода** в профиле (пользователь вводит «БКМ» → сохраняется canonical «белок коровьего молока»);
- **блокировки по токенам** в чате, автоплане и при фильтрации рецептов (одна запись аллергии разворачивается в набор подстрок для поиска в тексте).

## Важно: БКМ ≠ лактоза

**Белок коровьего молока (БКМ/АБКМ/CMPA)** и **лактоза** — разные аллергии:

- **БКМ** — аллергия на белки молока (казеин, сывороточные белки). Токены: молоко, сливки, йогурт, сыр, творог, кефир, казеин, сыворотка и т.д. **Токены БКМ не включают «лактоз»** — иначе рецепты «без лактозы» ошибочно блокировались бы при аллергии на БКМ.
- **Лактоза** — непереносимость молочного сахара. Токены: лактоза, lactose.

При необходимости у ребёнка могут быть указаны обе аллергии отдельно.

## Поддерживаемые алиасы (canonical + примеры ввода)

| Canonical (хранится в БД) | Примеры ввода (aliases) |
|---------------------------|--------------------------|
| белок коровьего молока    | БКМ, АБКМ, CMPA, cow milk protein, milk protein |
| лактоза                   | лактоза, ЛН, lactose |
| глютен                    | глютен, целиакия, gluten, celiac |
| яйца                      | яйцо, яйца, белок яйца, egg, egg white |
| рыба                      | рыба, fish |
| морепродукты              | морепродукты, МС, seafood, shellfish |
| орехи                     | орехи, tree nuts, nuts, др |
| арахис                    | арахис, peanut |
| соя                       | соя, soy, soya |
| кунжут                    | кунжут, sesame, тахини, tahini |
| мёд                       | мёд, мед, honey |
| горчица                   | горчица, mustard |
| сельдерей                 | сельдерей, celery |
| люпин                     | люпин, lupin |
| сульфиты                  | сульфиты, sulfites, e220, e-220 |

Полный список полей (`canonical`, `display`, `aliases`, `tokens`) задаётся в:
- **Клиент:** `src/utils/allergyAliases.ts`
- **Edge (Supabase):** `supabase/functions/_shared/allergyAliases.ts`

Словари должны совпадать между клиентом и Edge.

## Что не входит в словарь аллергий

- **Ягоды, фрукты, овощи как «не люблю»** — это предпочтения (dislikes/likes), а не аллергены в этом словаре. Не добавлять в `ALLERGY_ALIASES` кейсы вида «ягоды» как аллергию.

## Как добавить новый алиас

1. Открыть **оба** файла:
   - `src/utils/allergyAliases.ts`
   - `supabase/functions/_shared/allergyAliases.ts`
2. В массив `ALLERGY_ALIASES` добавить объект:
   - `canonical` — строка, которая сохраняется в `members.allergies` и по которой строится блокировка.
   - `display` — как показывать в UI (опционально).
   - `aliases` — варианты ввода (lowercase), по которым ввод нормализуется в `canonical`.
   - `tokens` — подстроки (стемы) для поиска в тексте рецепта/чата; проверка идёт через `includes`, без regex.
3. Запустить тесты:
   - клиент: `npm run test` (в т.ч. `src/utils/allergyAliases.test.ts`);
   - Edge: `deno test supabase/functions/_shared/allergyAliases.test.ts --allow-read`.
4. При изменении Edge — задеплоить функцию: `npm run supabase:deploy:chat` (или нужную функцию).

## Где используются токены

- **Профиль (UI):** при добавлении аллергии вызывается `normalizeAllergyInput()` → в БД сохраняется `canonical`.
- **Чат (клиент):** предпроверка запроса по токенам из `buildBlockedTokensFromAllergies(allergies)`.
- **Edge (deepseek-chat):** блокировка ответов по тем же токенам.
- **Автоплан / пул рецептов:** фильтрация по `getBlockedTokensFromAllergies(memberData.allergies)`.

Во всех местах используется единый путь: `expandAllergyToTokens` → `buildBlockedTokensFromAllergies`.
