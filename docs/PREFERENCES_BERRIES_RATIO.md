# Мягкое предпочтение «любит ягоды»: целевая доля 25%

## Цель

При предпочтении «любит ягоды» в недельном плане рецепты с ягодами должны появляться **примерно в 25% слотов** (1 из 4 блюд), а не в каждом приёме пищи.

## Как считается

- **Целевая доля:** `targetRatio = 0.25`.
- **Слот в неделе:** индекс слота `slotIndex` (0-based: 0..27 для 7 дней × 4 приёма).
- **Желаемое число ягодных слотов к текущему моменту:**  
  `desiredByNow = floor((slotIndex + 1) * targetRatio)`.
- **Нужно ли в этом слоте предпочитать ягоды:**  
  `wantBerries = (alreadyBerryCount < desiredByNow)`.

Примеры:
- При `total = 4` (один день): к 4-му слоту желаем 1 ягодный → в одном из четырёх слотов предпочитаем ягоды.
- При `total = 8`: к 8-му слоту желаем 2 ягодных → в двух из восьми слотов предпочитаем ягоды.

## Где включается

- **Автоплан (run):** при генерации недели по слотам передаётся `berryState: { alreadyBerryCount, slotIndex }` и `softPrefs: { berriesLiked }`.
- **Upgrade плана:** то же для цикла по дням и слотам.
- **replace_slot:** не передаётся `berryState`/`softPrefs` — логика «любит ягоды» не применяется (только автоплан).

## Приоритеты

1. **Аллерген-фильтр** — всегда раньше; рецепты с аллергенами отсекаются до любых предпочтений.
2. **Lunch soup-only** — обед только супы; ягоды не подменяют тип блюда.
3. **Мягкое предпочтение ягод** — после фильтров: в части слотов предпочитаем ягодные рецепты, в остальных слегка смещаем выбор в сторону не-ягодных (но не запрещаем ягоды полностью).

## Токены «ягодного» рецепта

Проверка по подстрокам в title / description / tags / ingredients:

- **RU:** ягод, черник, малина, клубник, смородин, землян, ежевик  
- **EN:** berry, berries, blueberry, raspberry, strawberry, blackcurrant, blackberry  

Определение: `_shared/preferences.ts` → `isBerryRecipe(recipe)`.

## Поведение в pickFromPool

- Если `berriesLiked` и передан `berryState`:
  - **wantBerries = true:** сначала выбираем из кандидатов с `isBerryRecipe === true` (после аллергий и mealType); если таких нет — обычный выбор из всех.
  - **wantBerries = false:** сначала выбираем из не-ягодных; если таких нет — из всех (без жёсткого запрета ягод).

При отсутствии ягодных рецептов в пуле план строится как раньше, без ошибок.
