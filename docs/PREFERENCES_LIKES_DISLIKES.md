# Предпочтения: allergies, likes, dislikes

В профиле (member) используются три типа ограничений и предпочтений.

## 1. Аллергии (allergies) — safety, hard

- **Колонка:** `public.members.allergies` (и/или `allergy_items` с флагами активности).
- **Смысл:** Жёсткий запрет по безопасности. Рецепты с аллергеном не предлагаются ни в автоплане, ни в чате; ручная подстановка в план не блокируется на уровне UI, но данные профиля содержат предупреждение.
- **Использование:** generate-plan и deepseek-chat исключают рецепты по токенам аллергенов; при запросе в чате с упоминанием аллергена возвращается отказ.

## 2. Не любит (dislikes) — hard для автогенерации и чата

- **Колонка:** `public.members.dislikes` (text[], по умолчанию `'{}'`).
- **Смысл:** Жёсткое исключение при автоподборе и в чате. Не «аллергия», а «не ест / не любит» (например: лук, мясо).
- **Использование:**
  - **generate-plan:** после фильтра по аллергиям кандидаты отфильтровываются по токенам из `dislikes` (по title/description/tags/ingredients). Ручной assign в план **не** блокируется.
  - **deepseek-chat:** если в запросе пользователя есть токен из `dislikes`, возвращается отказ с формулировкой вида «у профиля указано „не любит …“».
- **UI:** отдельный блок «Не любит» в редактировании профиля (чипы, до 20 пунктов).

## 3. Любит (likes) — soft, ratio

- **Колонка:** `public.members.likes` (text[], по умолчанию `'{}'`).
- **Смысл:** Мягкие предпочтения для баланса недели (например, «чаще ягоды»). Не означают «только любимое».
- **Использование:** extractSoftPrefs(member) читает `member.likes`; существующий механизм soft-скоринга (в т.ч. доля ягодных рецептов) использует эти данные. Не создаёт жёстких запретов.
- **UI:** отдельный блок «Любит» в редактировании профиля (чипы, до 20 пунктов).

## Legacy: preferences

- **Колонка:** `public.members.preferences` (text[]) **не удаляется**; оставлена для совместимости.
- Логика приложения **читает и пишет** `likes` и `dislikes`. При сохранении профиля `preferences` не перезаписываются.
- Миграция backfill перенесла данные из `preferences` в `likes`/`dislikes` по правилам парсинга («не любит …» → dislikes, «любит …» / отдельные слова → likes).

## Итог

| Поле       | Тип   | Автоплан              | Чат (отказ)     | Ручной assign |
|-----------|-------|------------------------|-----------------|----------------|
| allergies | safety| исключение             | да              | не блокируем  |
| dislikes  | hard  | исключение по токенам | да              | не блокируем  |
| likes     | soft  | учёт в скоринге/ratio | не отказ        | —             |
