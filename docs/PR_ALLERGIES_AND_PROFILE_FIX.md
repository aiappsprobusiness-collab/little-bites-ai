# PR: Аллергии и профиль в плане и чате

## Где был разрыв

1. **План (day/week/fill/replace_slot):**
   - Фильтр по аллергиям применялся по токенам из `tokenize(allergy)` без расширения. Для аллергии «курица» получался только токен «курица»; в названии «Суп с курицей и овощами» подстрока «курица» не входит в «курицей» → рецепт не отфильтровывался.
   - Фильтр по профилю (аллергии) шёл после soup-only для lunch; требовался порядок: сначала аллерген, потом тип блюда.

2. **Чат:**
   - Проверка была только по точному совпадению слова запроса с элементом списка аллергий. Запрос «ореховый пудинг» даёт слова «ореховый», «пудинг»; аллергия «орехи» не совпадала → модель генерировала рецепт без орехов (подмена).
   - При отказе по аллергии API возвращал только текст; клиент не получал рецепт и подставлял общее «Не удалось распознать рецепт» вместо сообщения об аллергии.

3. **Валидация рецепта после генерации:** проверка была по `text.includes(term)` для каждого allergy; для «курица» не срабатывало на «курицей».

## Что сделано

- **Единый словарь аллергенов (Edge):** `supabase/functions/_shared/allergens.ts` — `buildAllergenSet(allergies)`, `isRecipeAllowedByAllergens(recipe, set)`, расширения для курицы (кур, куриц, chicken), орехов (орех, nut), молока, яиц, рыбы, глютена. generate-plan использует `getBlockedTokensFromAllergies(memberData?.allergies)` и фильтр по аллергиям перенесён до soup-only в `pickFromPool`.
- **Клиент:** `src/utils/allergenTokens.ts` — тот же словарь, `buildBlockedTokens`, `containsAnyToken`. Используется в `chatAllergyCheck` (подстроки в запросе), `validateRecipe` (пост-валидация рецепта), `recipePool.passesProfileFilter`.
- **Чат:** при срабатывании проверки аллергии возвращается `{ message: "...", blockedByAllergy: true }` с текстом вида «У профиля &lt;имя&gt; указана аллергия на: … Не могу предложить рецепт с этим ингредиентом. Могу предложить ужин с индейкой, рыбой или овощами.»; в ChatPage при `blockedByAllergy` показывается это сообщение, а не «Не удалось распознать рецепт».
- **Без подмены:** запрос с ключевым аллергеном (ореховый, курица и т.п.) не отправляется в модель — сразу отказ.

## Тесты

- `supabase/functions/_shared/allergens.test.ts`: chicken/nuts в buildAllergenSet, isRecipeAllowedByAllergens (reject/allow), containsAnyToken.
- Существующие `generation.spec.ts` (validateRecipe) сохранены; validateRecipe переведён на buildBlockedTokens/containsAnyToken.

## Предпочтения «любит ягоды» (soft)

Цель: ~25% рецептов с ягодами на неделю. Реализацию счётчика на уровне day/week generation можно добавить отдельно (ограничение использования preferenceIngredient до N раз за период).
