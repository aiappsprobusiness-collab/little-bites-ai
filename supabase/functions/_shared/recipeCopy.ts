/**
 * Разнообразие description и chefAdvice: шаблоны и замена слишком общих формулировок.
 * Выбор шаблона через hash(userText + title) для детерминированного разнообразия.
 * chefAdvice: только кулинарные советы (вкус, аромат, текстура, подача, хранение).
 * description: 1–2 предложения, упоминание ключевого ингредиента или текстуры.
 * Не упоминать возраст, аллергию, ребёнка.
 */

const DESCRIPTION_TEMPLATES = [
  "Лёгкое блюдо, которое хорошо подходит для любого приёма пищи.",
  "Сбалансированное сочетание ингредиентов и простой способ приготовления.",
  "Простой и быстрый вариант с минимумом усилий.",
  "Ароматное блюдо с насыщенным вкусом.",
  "Домашний вариант, который легко повторить.",
  "Идеально подходит для сытного приёма пищи.",
  "Сытное, но при этом не тяжёлое блюдо.",
  "Отличный выбор для разнообразия меню.",
  "Богато полезными веществами и при этом вкусно.",
  "Готовится из доступных ингредиентов.",
  "Нежная текстура и приятный вкус.",
  "Универсальное блюдо на каждый день.",
  "Вкусное и питательное сочетание.",
  "Минимум времени — максимум пользы.",
  "Подойдёт и для будней, и для особого случая.",
  "Аппетитный вид и насыщенный вкус.",
  "Классическое сочетание, проверенное временем.",
  "Легко адаптировать под свой вкус.",
  "Хорошо хранится и подходит для запаса.",
  "Простые шаги и предсказуемый результат.",
];

const CHEF_ADVICE_TEMPLATES = [
  "Подавайте тёплым — так вкус раскрывается лучше.",
  "Для аромата можно добавить свежую зелень перед подачей.",
  "Храните в холодильнике не более 2 дней в закрытой посуде.",
  "Соль и специи лучше добавлять в конце приготовления.",
  "Не переваривайте — текстура должна остаться нежной.",
  "Отлично сочетается с овощами или лёгким салатом.",
  "Перед подачей дайте блюду 2–3 минуты постоять.",
  "Для кремовой текстуры можно слегка взбить перед подачей.",
  "Лучше готовить на один раз — так вкус ярче.",
  "Можно слегка сбрызнуть маслом или соком лимона.",
  "Храните в герметичном контейнере в прохладном месте.",
  "Пробуйте на соль и специи в конце и при необходимости скорректируйте.",
  "Идеальная температура подачи — тёплая, не обжигающая.",
  "Для сочности не выключайте огонь сразу — дайте потомиться под крышкой.",
  "Свежая зелень сверху улучшит и вид, и вкус.",
  "Сочетается с крупами и тушёными овощами.",
  "Можно приготовить с запасом и разогреть перед едой.",
  "Не накрывайте плотно при остывании — иначе размокнет.",
  "Для яркого вкуса используйте качественные специи.",
  "Подавайте сразу после приготовления для лучшей текстуры.",
  "Можно заменить один ингредиент на аналогичный по вкусу.",
  "Хранить в холоде не более 24 часов.",
  "Перед подачей проверьте температуру — не слишком горячо.",
  "Отлично дополняет утренний или вечерний приём пищи.",
  "Для нежности не пересушивайте на огне.",
  "Сохраняет форму и вкус при аккуратном разогреве.",
  "Добавьте каплю масла при подаче для блеска и вкуса.",
  "Лучше есть свежеприготовленным.",
  "Сочетается с хлебом или лавашом.",
  "Можно подать с соусом по вкусу.",
];

const GENERIC_DESCRIPTION_PATTERNS = [
  /^Лёгкое блюдо, которое\s/i,
  /^Нежн(ое|ый|ая|ые) блюдо/i,
  /^Вкусн(ое|ый|ая|ые) и полезн/i,
  /^Прост(ое|ый|ая|ые) и быстр/i,
];

/**
 * Простой числовой хэш от строки для выбора шаблона (детерминировано).
 */
function simpleHash(str: string): number {
  let h = 0;
  const s = (str ?? "").trim();
  for (let i = 0; i < s.length; i++) {
    h = (h * 31 + s.charCodeAt(i)) >>> 0;
  }
  return h;
}

/**
 * Проверяет, что текст не пустой и не слишком общий (шаблонный).
 */
export function isGenericText(text: string | null | undefined): boolean {
  const t = (text ?? "").trim();
  if (t.length < 10) return true;
  if (GENERIC_DESCRIPTION_PATTERNS.some((re) => re.test(t))) return true;
  const lower = t.toLowerCase();
  if (lower.startsWith("лёгкое блюдо, которое") || lower.startsWith("легкое блюдо, которое")) return true;
  return false;
}

/**
 * Строит description по шаблону с учётом title/userText для разнообразия.
 * seed = userText + title (или только title).
 */
export function buildRecipeDescription(options: {
  title: string;
  userText?: string;
  keyIngredient?: string;
}): string {
  const seed = ((options.userText ?? "") + (options.title ?? "")).trim() || "default";
  const idx = simpleHash(seed) % DESCRIPTION_TEMPLATES.length;
  const template = DESCRIPTION_TEMPLATES[idx] ?? DESCRIPTION_TEMPLATES[0];
  if (options.keyIngredient && template.includes("ингредиентов")) {
    return template.replace("ингредиентов", `${options.keyIngredient} и других ингредиентов`);
  }
  return template;
}

/**
 * Строит chefAdvice по шаблону (только кулинарные советы, без возраста/аллергии).
 */
export function buildChefAdvice(options: { title: string; userText?: string }): string {
  const seed = ((options.userText ?? "") + (options.title ?? "")).trim() || "default";
  const idx = simpleHash(seed) % CHEF_ADVICE_TEMPLATES.length;
  return CHEF_ADVICE_TEMPLATES[idx] ?? CHEF_ADVICE_TEMPLATES[0];
}
