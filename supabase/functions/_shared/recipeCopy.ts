/**
 * Разнообразие description и chefAdvice. Замена только при пустом/коротком/болванке.
 * description: 2–4 предложения (что за блюдо, ингредиенты+вкус, консистенция/подача, хранение).
 * chefAdvice: 1–2 предложения, только кулинарные советы. Без возраста/аллергий/ребёнка.
 */

/** Минимальная длина описания в символах; ниже — считаем коротким и допускаем замену. */
export const DESCRIPTION_MIN_LENGTH = 160;

/** Однострочные болванки: если description совпадает с одной из них — заменяем на 2–4 предложения. */
const STUB_DESCRIPTION_PHRASES: string[] = [
  "Лёгкое блюдо, которое хорошо подходит для любого приёма пищи.",
  "Сбалансированное сочетание ингредиентов и простой способ приготовления.",
  "Простой и быстрый вариант с минимумом усилий.",
  "Ароматное блюдо с насыщенным вкусом.",
  "Домашний вариант, который легко повторить.",
  "Идеально подходит для сытного приёма пищи.",
  "Сытное, но при этом не тяжёлое блюдо.",
  "Отличный выбор для разнообразия меню.",
  "Богато полезными веществами и при этом вкусно.",
  "Готовится из доступных ингредиентов.",
  "Нежная текстура и приятный вкус.",
  "Универсальное блюдо на каждый день.",
  "Вкусное и питательное сочетание.",
  "Минимум времени — максимум пользы.",
  "Подойдёт и для будней, и для особого случая.",
  "Аппетитный вид и насыщенный вкус.",
  "Классическое сочетание, проверенное временем.",
  "Легко адаптировать под свой вкус.",
  "Хорошо хранится и подходит для запаса.",
  "Простые шаги и предсказуемый результат.",
];

/** Первые предложения (что за блюдо). {{title}} или контекст по ключевому ингредиенту. */
const FIRST_SENTENCES = [
  "{{title}} — сытное и полезное блюдо с простым составом.",
  "{{title}} готовится из доступных ингредиентов и подходит для любого приёма пищи.",
  "Это блюдо сочетает питательность и нежную текстуру.",
  "{{title}} можно подавать на завтрак, в качестве перекуса или лёгкого ужина.",
  "Простое в приготовлении блюдо с насыщенным вкусом.",
  "{{title}} — сбалансированный вариант с минимумом усилий на кухне.",
  "Нежная консистенция и приятный вкус делают это блюдо универсальным.",
  "{{title}} богат полезными веществами и хорошо насыщает.",
  "Классический вариант, который легко повторить дома.",
  "Ароматное и аппетитное блюдо для повседневного меню.",
  "{{title}} подойдёт и для будней, и для особого случая.",
  "Сытное, но при этом не тяжёлое блюдо с приятной текстурой.",
  "Готовится быстро, хранится в холодильнике до двух дней.",
  "{{title}} — отличный выбор для разнообразия рациона.",
  "В составе — простые ингредиенты, результат предсказуемо вкусный.",
];

/** Вторые предложения: ключевой ингредиент + вкус/текстура. */
const SECOND_SENTENCES = [
  "В составе — {{keyIngredient}} и другие базовые продукты, текстура нежная, подходит для всей семьи.",
  "{{keyIngredient}} даёт основу вкуса и консистенции; блюдо получается однородным и приятным.",
  "Основной акцент на {{keyIngredient}} — блюдо выходит сытным и ароматным.",
  "{{keyIngredient}} и дополняющие ингредиенты создают сбалансированный вкус и мягкую текстуру.",
  "За счёт {{keyIngredient}} блюдо получается питательным и легко усваивается.",
  "{{keyIngredient}} в основе рецепта обеспечивает нежность и приятную консистенцию.",
  "Сочетание {{keyIngredient}} с остальными компонентами даёт насыщенный вкус без лишней сложности.",
  "{{keyIngredient}} — главный ингредиент; вкус и текстура получаются однородными и приятными.",
  "В рецепте используются {{keyIngredient}} и простые добавки для нежной текстуры и вкуса.",
  "{{keyIngredient}} придаёт блюду основу; консистенция может быть пюреобразной или чуть гуще.",
];

/** Третьи предложения (опционально): консистенция, подача. */
const THIRD_SENTENCES = [
  "Консистенцию можно регулировать количеством жидкости — от пюреобразной до более густой.",
  "Подавайте тёплым; при необходимости можно разогреть порцию перед едой.",
  "Густоту легко скорректировать под свой вкус в процессе приготовления.",
  "Идеально подавать сразу после приготовления, пока текстура нежная.",
  "Можно оставить блюдо более жидким или уварить до густоты по желанию.",
];

/** Четвёртые предложения (опционально): хранение. */
const FOURTH_SENTENCES = [
  "Хранить в холодильнике в закрытой посуде не более 2 дней; разогревать перед подачей.",
  "Готовое блюдо хорошо хранится в холоде до 24–48 часов.",
  "При необходимости приготовьте с запасом и разогрейте нужную порцию.",
];

const CHEF_ADVICE_TEMPLATES = [
  "Подавайте тёплым — так вкус раскрывается лучше. Перед подачей дайте 2–3 минуты постоять.",
  "Для аромата можно добавить свежую зелень перед подачей. Соль и специи лучше добавлять в конце.",
  "Храните в холодильнике не более 2 дней в закрытой посуде. Разогревайте порцию перед едой.",
  "Не переваривайте — текстура должна остаться нежной. Для сочности дайте потомиться под крышкой.",
  "Отлично сочетается с овощами или лёгким салатом. Свежая зелень сверху улучшит вид и вкус.",
  "Для кремовой текстуры можно слегка взбить перед подачей. Подавайте сразу после приготовления.",
  "Можно слегка сбрызнуть маслом или соком лимона. Пробуйте на соль в конце и скорректируйте.",
  "Храните в герметичном контейнере в прохладном месте. Идеальная температура подачи — тёплая.",
  "Для яркого вкуса используйте качественные специи. Сочетается с крупами и тушёными овощами.",
  "Можно приготовить с запасом и разогреть перед едой. Не накрывайте плотно при остывании.",
  "Для нежности не пересушивайте на огне. Сохраняет форму и вкус при аккуратном разогреве.",
  "Добавьте каплю масла при подаче для блеска и вкуса. Лучше есть свежеприготовленным.",
  "Сочетается с хлебом или лавашом. Можно подать с соусом по вкусу.",
  "Перед подачей проверьте температуру — не слишком горячо. Хранить в холоде не более 24 часов.",
  "Можно заменить один ингредиент на аналогичный по вкусу. Текстура от этого почти не пострадает.",
];

/** Минимальная длина chefAdvice; ниже — допускаем замену. */
const CHEF_ADVICE_MIN_LENGTH = 40;

function simpleHash(str: string): number {
  let h = 0;
  const s = (str ?? "").trim();
  for (let i = 0; i < s.length; i++) {
    h = (h * 31 + s.charCodeAt(i)) >>> 0;
  }
  return h;
}

function pickByHash<T>(arr: T[], seed: string): T {
  const idx = simpleHash(seed) % arr.length;
  return arr[idx] ?? arr[0];
}

/**
 * Замена description допускается только если: пустой, слишком короткий (< DESCRIPTION_MIN_LENGTH),
 * или совпадает с одной из известных однострочных болванок.
 */
export function shouldReplaceDescription(desc: string | null | undefined): boolean {
  const t = (desc ?? "").trim();
  if (t.length === 0) return true;
  if (t.length < DESCRIPTION_MIN_LENGTH) return true;
  const normalizedStub = t.toLowerCase().replace(/\s+/g, " ");
  for (const stub of STUB_DESCRIPTION_PHRASES) {
    if (stub.toLowerCase().replace(/\s+/g, " ") === normalizedStub) return true;
  }
  return false;
}

/**
 * Замена chefAdvice допускается только если пустой или слишком короткий.
 */
export function shouldReplaceChefAdvice(advice: string | null | undefined): boolean {
  const t = (advice ?? "").trim();
  if (t.length === 0) return true;
  if (t.length < CHEF_ADVICE_MIN_LENGTH) return true;
  return false;
}

/**
 * Проверяет, что текст похож на общую болванку (для обратной совместимости).
 * Используйте shouldReplaceDescription для решения о замене description.
 */
export function isGenericText(text: string | null | undefined): boolean {
  return shouldReplaceDescription(text);
}

/**
 * Строит description из 2–4 предложений: что за блюдо, ингредиенты+вкус, опционально консистенция/подача и хранение.
 * Всегда >= 2 предложений, целевая длина >= DESCRIPTION_MIN_LENGTH.
 */
export function buildRecipeDescription(options: {
  title: string;
  userText?: string;
  keyIngredient?: string;
}): string {
  const title = (options.title ?? "").trim() || "Блюдо";
  const keyIngredient = (options.keyIngredient ?? "").trim() || "основные ингредиенты";
  const seed = ((options.userText ?? "") + title).trim() || "default";

  const firstRaw = pickByHash(FIRST_SENTENCES, seed + "1");
  const first = firstRaw.replace(/\{\{title\}\}/g, title);

  const secondRaw = pickByHash(SECOND_SENTENCES, seed + "2");
  const second = secondRaw.replace(/\{\{keyIngredient\}\}/g, keyIngredient);

  const parts: string[] = [first, second];

  if (simpleHash(seed + "3") % 3 === 0) {
    parts.push(pickByHash(THIRD_SENTENCES, seed + "3"));
  }
  if (simpleHash(seed + "4") % 5 === 0) {
    parts.push(pickByHash(FOURTH_SENTENCES, seed + "4"));
  }

  const result = parts.join(" ").trim();
  return result.length >= DESCRIPTION_MIN_LENGTH ? result : result + " Хранить в холодильнике не более 2 дней.";
}

/**
 * Строит chefAdvice: 1–2 предложения, только кулинарные советы (вкус, техника, подача, хранение).
 */
export function buildChefAdvice(options: { title: string; userText?: string }): string {
  const seed = ((options.userText ?? "") + (options.title ?? "")).trim() || "default";
  return pickByHash(CHEF_ADVICE_TEMPLATES, seed);
}
