/**
 * Локальный словарь замен ингредиентов (без AI).
 * Формат: ключ — название в нижнем регистре, значение — массив { option, why }.
 */

export interface SubstituteOption {
  option: string;
  why: string;
}

const DICT: Record<string, SubstituteOption[]> = {
  молоко: [
    { option: "кефир", why: "кисломолочный продукт, похожая консистенция" },
    { option: "йогурт", why: "кисломолочная альтернатива, хорошо в выпечке" },
    { option: "растительное молоко (овсяное, рисовое)", why: "подходит при непереносимости лактозы" },
  ],
  "молоко коровье": [
    { option: "кефир", why: "кисломолочный продукт, похожая консистенция" },
    { option: "йогурт", why: "кисломолочная альтернатива" },
    { option: "растительное молоко", why: "без лактозы" },
  ],
  яйца: [
    { option: "перепелиные яйца", why: "меньше аллергенны, 1 куриное ≈ 3–4 перепелиных" },
    { option: "банан (для выпечки)", why: "½ банана ≈ 1 яйцо, придаёт влажность" },
    { option: "льняное «яйцо» (1 ст.л. семян + 3 ст.л. воды)", why: "подходит для веганской выпечки" },
  ],
  яйцо: [
    { option: "перепелиные яйца", why: "меньше аллергенны" },
    { option: "банан (для выпечки)", why: "½ банана ≈ 1 яйцо" },
    { option: "льняное «яйцо»", why: "1 ст.л. семян + 3 ст.л. воды" },
  ],
  курица: [
    { option: "индейка", why: "нежирное мясо, похожая текстура" },
    { option: "кролик", why: "гипоаллергенное мясо, легко усваивается" },
    { option: "рыба (белая)", why: "альтернатива белку, например треска, минтай" },
  ],
  "куриная грудка": [
    { option: "индейка", why: "похожая текстура и вкус" },
    { option: "кролик", why: "гипоаллергенно" },
    { option: "телятина", why: "нежирное мясо" },
  ],
  "пшеничная мука": [
    { option: "овсяная мука", why: "без глютена, больше клетчатки" },
    { option: "рисовая мука", why: "без глютена, нейтральный вкус" },
    { option: "гречневая мука", why: "без глютена, полезнее" },
  ],
  мука: [
    { option: "овсяная мука", why: "без глютена" },
    { option: "рисовая мука", why: "без глютена, нейтральный вкус" },
    { option: "гречневая мука", why: "без глютена" },
  ],
  "сливочное масло": [
    { option: "растительное масло", why: "подходит для жарки и выпечки" },
    { option: "кокосовое масло", why: "для выпечки, придаёт лёгкий аромат" },
    { option: "топлёное масло (гхи)", why: "без лактозы, хорошо для жарки" },
  ],
  масло: [
    { option: "растительное масло", why: "универсальная замена" },
    { option: "кокосовое масло", why: "для выпечки" },
    { option: "топлёное масло", why: "без лактозы" },
  ],
  сахар: [
    { option: "мёд (с 1 года)", why: "натуральный подсластитель, меньше доза" },
    { option: "банан (пюре)", why: "натуральная сладость, полезнее" },
    { option: "стевия", why: "без калорий, для детей по возрасту" },
  ],
  сметана: [
    { option: "йогурт натуральный", why: "похожая консистенция, меньше жира" },
    { option: "кефир", why: "кисломолочная альтернатива" },
    { option: "растительные сливки (овсяные)", why: "для соусов без молока" },
  ],
  творог: [
    { option: "йогурт густой", why: "похожий белок и кальций" },
    { option: "рикотта", why: "мягкий сыр, подходит в выпечку" },
    { option: "тофу мягкий", why: "растительный белок" },
  ],
  лук: [
    { option: "лук-порей", why: "мягче вкус, легче для желудка" },
    { option: "сельдерей", why: "добавляет аромат без остроты" },
    { option: "морковь", why: "сладковатый вкус, больше витаминов" },
  ],
  чеснок: [
    { option: "лук-порей", why: "мягкий луковый аромат" },
    { option: "укроп", why: "свежая зелень без остроты" },
    { option: "пропустить", why: "для малышей можно не добавлять" },
  ],
  "коровье молоко": [
    { option: "кефир", why: "кисломолочный продукт" },
    { option: "йогурт", why: "кисломолочная альтернатива" },
    { option: "растительное молоко", why: "без лактозы" },
  ],
};

/** Получить до 3 вариантов замены по названию ингредиента. */
export function getSubstituteOptions(ingredientName: string, substituteFromDb?: string | null): SubstituteOption[] {
  if (typeof substituteFromDb === "string" && substituteFromDb.trim()) {
    return parseSubstituteFromDb(substituteFromDb);
  }
  const name = ingredientName.trim().toLowerCase();
  if (!name) return getDefaultOptions();

  // Точное совпадение
  if (DICT[name]) return DICT[name].slice(0, 3);

  // Частичное: ищем по первому слову или ключу
  const firstWord = name.split(/\s+/)[0] ?? name;
  if (DICT[firstWord]) return DICT[firstWord].slice(0, 3);

  // Поиск ключа, который содержится в названии
  for (const key of Object.keys(DICT)) {
    if (name.includes(key)) return DICT[key].slice(0, 3);
  }

  return getDefaultOptions();
}

/** Распарсить substitute из БД: "вариант1, вариант2" или "вариант1; вариант2". */
function parseSubstituteFromDb(text: string): SubstituteOption[] {
  const parts = text.split(/[,;]/).map((s) => s.trim()).filter(Boolean);
  return parts.slice(0, 3).map((option) => ({
    option,
    why: "подходящая альтернатива",
  }));
}

function getDefaultOptions(): SubstituteOption[] {
  return [
    { option: "аналогичный продукт", why: "подберите по своему вкусу и переносимости" },
    { option: "пропустить", why: "можно исключить при необходимости" },
    { option: "уменьшить количество", why: "если есть ограничения" },
  ];
}
