/**
 * Suggested follow-up chips для help-чата. Генерация на фронте по ключевым словам в последнем ответе ассистента.
 */

export interface HelpFollowupChip {
  label: string;
  prefill: string;
}

const DEFAULT_CHIPS: HelpFollowupChip[] = [
  { label: "Это похоже на аллергию?", prefill: "Это похоже на аллергию?" },
  { label: "Когда нужно обратиться к врачу?", prefill: "Когда нужно обратиться к врачу?" },
  { label: "Что можно сделать дома сейчас?", prefill: "Что можно сделать дома сейчас?" },
  { label: "Какие уточняющие вопросы важны?", prefill: "Какие уточняющие вопросы важны?" },
  { label: "Как понять, что стало лучше?", prefill: "Как понять, что стало лучше?" },
];

const RULES: { pattern: RegExp; chips: HelpFollowupChip[] }[] = [
  {
    pattern: /сыпь|аллерг|реакц|пятн|зуд/,
    chips: [
      { label: "Это похоже на аллергию или раздражение?", prefill: "Это похоже на аллергию или раздражение?" },
      { label: "Можно ли снова дать этот продукт?", prefill: "Можно ли снова дать этот продукт?" },
      { label: "Когда пробовать повторно?", prefill: "Когда пробовать повторно?" },
      { label: "Что важно отследить в ближайшие сутки?", prefill: "Что важно отследить в ближайшие сутки?" },
      { label: "Когда срочно к врачу?", prefill: "Когда срочно к врачу?" },
    ],
  },
  {
    pattern: /стул|понос|диар|запор|кал/,
    chips: [
      { label: "Какие варианты нормы для возраста?", prefill: "Какие варианты нормы для возраста?" },
      { label: "Что дать пить и как часто?", prefill: "Что дать пить и как часто?" },
      { label: "Когда это уже опасно?", prefill: "Когда это уже опасно?" },
      { label: "Что могло вызвать изменения?", prefill: "Что могло вызвать изменения?" },
      { label: "Какие признаки обезвоживания?", prefill: "Какие признаки обезвоживания?" },
    ],
  },
  {
    pattern: /срыг|рвот|тошн/,
    chips: [
      { label: "Срыгивания: где граница нормы?", prefill: "Срыгивания: где граница нормы?" },
      { label: "Когда это повод для врача?", prefill: "Когда это повод для врача?" },
      { label: "Как кормить/держать после еды?", prefill: "Как кормить/держать после еды?" },
      { label: "Что исключить на 1–2 дня?", prefill: "Что исключить на 1–2 дня?" },
      { label: "Какие симптомы тревожные?", prefill: "Какие симптомы тревожные?" },
    ],
  },
  {
    pattern: /не ест|отказ|аппетит|приверед/,
    chips: [
      { label: "Сколько достаточно съедать в день?", prefill: "Сколько достаточно съедать в день?" },
      { label: "Как не закрепить отказ?", prefill: "Как не закрепить отказ?" },
      { label: "Какие продукты предложить мягко?", prefill: "Какие продукты предложить мягко?" },
      { label: "Когда это может быть болезнью?", prefill: "Когда это может быть болезнью?" },
      { label: "Какой режим питания лучше?", prefill: "Какой режим питания лучше?" },
    ],
  },
  {
    pattern: /температ|вял|сонлив|затрудн|дых/,
    chips: [
      { label: "Какие симптомы срочные?", prefill: "Какие симптомы срочные?" },
      { label: "Что сделать прямо сейчас?", prefill: "Что сделать прямо сейчас?" },
      { label: "Какие данные подготовить врачу?", prefill: "Какие данные подготовить врачу?" },
      { label: "Когда вызывать скорую?", prefill: "Когда вызывать скорую?" },
      { label: "Чем можно помочь дома безопасно?", prefill: "Чем можно помочь дома безопасно?" },
    ],
  },
];

const MAX_CHIPS = 6;

/**
 * Возвращает 3–6 follow-up чипсов по тексту последнего ответа ассистента.
 * Проверка по ключевым словам (нижний регистр). Если ничего не матчится — дефолтный набор.
 */
export function getHelpFollowups(lastAssistantText: string): HelpFollowupChip[] {
  const lower = lastAssistantText.toLowerCase().trim();
  if (!lower) return DEFAULT_CHIPS.slice(0, MAX_CHIPS);

  for (const { pattern, chips } of RULES) {
    if (pattern.test(lower)) {
      return chips.slice(0, MAX_CHIPS);
    }
  }

  return DEFAULT_CHIPS.slice(0, MAX_CHIPS);
}
