/**
 * Утилиты для работы с продуктами: категории и единицы измерения.
 * Гарантирует, что у каждого продукта есть единица измерения (никогда null).
 */

/** Продукты, измеряемые в штуках */
const COUNTABLE = [
  'яблоко', 'яблок', 'груша', 'банан', 'апельсин', 'мандарин', 'лимон', 'лайм',
  'персик', 'абрикос', 'слива', 'киви', 'авокадо', 'гранат', 'хурма', 'инжир',
  'финик', 'помело', 'грейпфрут', 'нектарин', 'айва', 'яйцо', 'яйц',
  'картофель', 'картошка', 'лук', 'головка лука', 'чеснок', 'зубчик', 'огурец',
  'помидор', 'томат', 'перец', 'кабачок', 'баклажан', 'тыква', 'морковь',
  'свекла', 'редис', 'редиска', 'капуста', 'кочан', 'лайм', 'луковица',
  'булка', 'батон', 'бублик', 'сушка', 'вафл', 'пряник', 'печенье', 'крекер',
  'котлета', 'тефтел', 'оладь', 'блин', 'шашлык', 'стейк', 'шницель',
  'вареник', 'пельмен', 'манты', 'чебурек', 'пирожок', 'пирог', 'рулет',
  'бутерброд', 'сэндвич', 'тост', 'гренк', 'сухарь', 'хлебец', 'хлебцы',
  'кусок', 'ломтик', 'долька', 'дольки', 'половинка', 'четвертинка',
  'ветчина', 'колбаса', 'сосиск', 'сардел', 'рулет',
];

/** Продукты, измеряемые в объёме (мл) */
const VOLUME = [
  'молоко', 'кефир', 'йогурт', 'ряженка', 'простокваша', 'сливки', 'сметана',
  'вода', 'сок', 'бульон', 'масло растительное', 'масло оливковое', 'подсолнечное',
  'уксус', 'вино', 'пиво', 'компот', 'морс', 'кисель', 'отвар',
  'маринад', 'соус', 'растительное масло', 'оливковое масло',
  'жидкость', 'настой', 'сироп', 'мёд жидкий',
];

/** Продукты, измеряемые по весу (г). Остальное — по умолчанию "шт". */
const WEIGHT = [
  'мука', 'сахар', 'соль', 'перец молотый', 'специи', 'крупа', 'рис', 'гречка',
  'овсянка', 'пшено', 'манка', 'перловка', 'булгур', 'киноа', 'чечевица', 'нут',
  'фасоль', 'горох', 'бобы', 'макарон', 'вермишель', 'лапша', 'спагетти',
  'мясо', 'говядина', 'свинина', 'куриц', 'индейк', 'фарш', 'рыба', 'лосось',
  'треска', 'минтай', 'творог', 'сыр', 'брынза', 'моцарелла', 'пармезан',
  'орех', 'миндал', 'грецкий', 'фундук', 'кешью', 'арахис', 'семечк', 'семена',
  'изюм', 'курага', 'чернослив', 'сухофрукт', 'мед', 'мёд', 'варенье', 'джем',
  'шоколад', 'какао', 'пудра', 'крахмал', 'разрыхлитель', 'сода', 'дрожжи',
  'зелень', 'петрушка', 'укроп', 'базилик', 'кинза', 'сельдерей', 'шпинат',
  'капуста тушеная', 'икра', 'паста', 'паштет', 'пюре', 'пюре из', 'хлопья',
  'отруби', 'клетчатка', 'протеин', 'порошок', 'пудра сахарная',
  'масло сливочное', 'сливочное масло', 'маргарин',
];

/**
 * Определяет категорию продукта по названию (для списка покупок и т.д.)
 */
export function detectCategory(name: string): string {
  const lowerName = name.toLowerCase().trim();

  const vegetables = [
    'морковь', 'картофель', 'картошка', 'лук', 'чеснок', 'капуста', 'брокколи',
    'цветная капуста', 'кабачок', 'баклажан', 'перец', 'томат', 'помидор', 'огурец', 'свекла',
    'тыква', 'шпинат', 'салат', 'петрушка', 'укроп', 'сельдерей', 'редис', 'горох', 'фасоль',
    'зелень', 'базилик', 'мята', 'кинза', 'зеленый лук', 'порей', 'цуккини',
    'патиссон', 'брюссельская капуста', 'кольраби', 'репа', 'брюква', 'дайкон', 'редиска',
    'руккола', 'кресс-салат', 'щавель', 'ревень', 'спаржа', 'артишок',
  ];
  if (vegetables.some((v) => lowerName.includes(v))) return 'vegetables';

  const fruits = [
    'яблоко', 'яблок', 'груша', 'банан', 'апельсин', 'мандарин', 'лимон', 'лайм',
    'виноград', 'клубника', 'малина', 'черника', 'голубика', 'смородина', 'вишня', 'черешня',
    'персик', 'абрикос', 'слива', 'манго', 'ананас', 'киви', 'дыня', 'арбуз', 'гранат',
    'хурма', 'инжир', 'финик', 'курага', 'изюм', 'чернослив', 'ягод', 'фрукт', 'помело',
    'грейпфрут', 'папайя', 'маракуйя', 'личи', 'рамбутан', 'дуриан', 'кокос',
    'фейхоа', 'нектарин', 'айва', 'крыжовник', 'облепиха', 'жимолость',
    'барбарис', 'рябина', 'калина', 'брусника', 'клюква', 'авокадо',
  ];
  if (fruits.some((f) => lowerName.includes(f))) return 'fruits';

  const dairy = [
    'молоко', 'кефир', 'йогурт', 'сметана', 'творог', 'сыр', 'масло сливочное',
    'сливки', 'ряженка', 'простокваша', 'брынза', 'моцарелла', 'пармезан', 'молочн',
    'творожок', 'сырок', 'сметанка', 'кефирчик', 'варенец', 'айран', 'тан', 'катык', 'кумыс', 'мацони', 'лактоза', 'сливочное масло',
  ];
  if (dairy.some((d) => lowerName.includes(d))) return 'dairy';

  const meat = [
    'мясо', 'говядина', 'свинина', 'курица', 'куриц', 'индейка', 'кролик', 'баранина',
    'фарш', 'колбаса', 'сосиски', 'ветчина', 'бекон', 'печень', 'сердце', 'язык',
    'рыба', 'лосось', 'семга', 'форель', 'треска', 'минтай', 'скумбрия', 'сельдь', 'тунец',
    'креветки', 'кальмар', 'морепродукт', 'филе', 'грудка', 'бедро', 'крыло', 'окорок',
    'телятина', 'козлятина', 'оленина', 'конина', 'утка', 'гусь', 'перепелка',
    'цесарка', 'фазан', 'краб', 'мидии', 'устрицы', 'осьминог', 'каракатица', 'икра',
  ];
  if (meat.some((m) => lowerName.includes(m))) return 'meat';

  const grains = [
    'рис', 'гречка', 'гречневая', 'овсянка', 'овсяные', 'пшено', 'перловка',
    'манка', 'манная', 'кускус', 'булгур', 'киноа', 'крупа', 'хлопья', 'мука', 'макароны',
    'спагетти', 'лапша', 'вермишель', 'хлеб', 'батон', 'булка', 'сухари', 'кукурузн',
    'пшеница', 'рожь', 'ячмень', 'овес', 'чечевица', 'нут', 'бобы', 'соя', 'тофу', 'сейтан', 'хлебцы', 'крекеры', 'печенье', 'вафли', 'пряники', 'сушки', 'баранки', 'бублики',
  ];
  if (grains.some((g) => lowerName.includes(g))) return 'grains';

  return 'other';
}

/**
 * Определяет единицу измерения продукта по названию.
 * Всегда возвращает непустую строку (шт / г / мл). Продуктов без меры не должно быть.
 */
export function detectUnit(name: string): string {
  if (!name || typeof name !== 'string') return 'шт';
  const lower = name.toLowerCase().trim();

  for (const w of VOLUME) {
    if (lower.includes(w)) return 'мл';
  }
  for (const w of WEIGHT) {
    if (lower.includes(w)) return 'г';
  }
  for (const w of COUNTABLE) {
    if (lower.includes(w)) return 'шт';
  }

  return 'шт';
}

/**
 * Возвращает единицу измерения: переданную (если задана) или определённую по названию.
 * Использовать при сохранении продукта/ингредиента, чтобы никогда не хранить null.
 */
export function resolveUnit(unit: string | null | undefined, productName: string): string {
  const u = typeof unit === 'string' ? unit.trim() : '';
  return u || detectUnit(productName);
}
